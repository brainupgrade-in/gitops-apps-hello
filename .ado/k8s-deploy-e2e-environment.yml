trigger: none

pool:
  # vmImage: 'ubuntu-latest'
  name: selfhosted

stages:
- stage: Build
  displayName: "Build and Push Docker Image"
  jobs:
  - job: BuildImage
    displayName: "Build Docker Image"
    steps:
    - task: Docker@2
      displayName: 'Docker Build'
      inputs:
        command: 'build'
        repository: 'brainupgrade/gitops-apps-hello'
        dockerfile: '**/Dockerfile'
        arguments: --build-arg='BUILD_ID=$(Build.BuildId)' --build-arg='GIT_COMMIT_ID=$(Build.SourceVersion)'
        tags: '$(Build.SourceVersion),latest'
  - job: PushDockerImage
    displayName: "Push Docker Image"
    steps:
    - task: Docker@2
      displayName: 'Docker Push'
      inputs:
        command: 'push'
        repository: 'brainupgrade/gitops-apps-hello'
        dockerfile: '**/Dockerfile'
        containerRegistry: 'docker-hub-credentials'
        tags: '$(Build.SourceVersion),latest'
- stage: e2e
  displayName: "E2E Deployment"
  jobs:
  - deployment: DeployToE2E
    displayName: "Deploy to E2E Environment"
    environment: 'e2e'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: Bash@3
            displayName: 'Check and Deploy to Kubernetes E2E Environment'
            inputs:
              targetType: 'inline'
              script: |
                if ! kubectl get deployment hello-e2e ; then
                  echo "Deployment not found, deploying now..."
                  kubectl create deploy hello-e2e --image=brainupgrade/gitops-apps-hello:$(Build.SourceVersion) 
                  kubectl set env deployment hello-e2e ENVIRONMENT=e2e 
                  kubectl expose deployment hello-e2e --port=8080 --target-port=8080 
                else
                  kubectl set image deployment hello-e2e gitops-apps-hello=brainupgrade/gitops-apps-hello:$(Build.SourceVersion) 
                fi
          - task: Bash@3
            displayName: "Verify Deployment"
            inputs:
              targetType: 'inline'
              script: |
                echo "Verifying the deployment..."
                kubectl get deploy -owide -l app=hello-e2e
